@model IEnumerable<QL_PHONGGYM.ViewModel.GioHangViewModel>
@{
    ViewBag.Title = "ToCheckOut";
    Layout = "~/Views/Shared/_LayoutPageCart.cshtml";
}

<form method="post" action="@Url.Action("XoaVaThanhToan", "CartCheckout")">
    <div class="mt-2 d-flex flex-column mx-auto justify-content-center px-5" style="margin-top: 200px; margin-bottom: 90px; width: 38rem">
        @Html.AntiForgeryToken()
        <div class="py-3 position-relative border-bottom border-1">
            <a href="@Url.Action("Index", "Home")" class="text-decoration-none position-absolute"><img src="@Url.Content("~/Content/Images/back.png")" style="width: 1.6rem; left: 3rem" /></a>
            <div class="w-100 text-center">
                <span class="fs-5 fw-bold text-black">Giỏ hàng của bạn</span>
            </div>
        </div>
        <div class="w-100 mt-3 d-flex flex-column">
            <a class="btn bg-primary text-white fw-semibold fs-6" href="@Url.Action("ToCheckOut", "CartCheckout")" style="width: 7rem">Giỏ hàng</a>
            <div class="d-flex justify-content-between mt-3">
                <div>
                    <input id="select-all" type="checkbox" class="form-check-input" />
                    <label class="form-check-label small" for="select-all">Chọn tất cả</label>
                </div>
                <button class="text-muted small fst-italic p-0 border-0 bg-transparent" name="actionType" value="delete">Xóa sản phẩm đã chọn</button>
            </div>
        </div>
        <div class="mt-3 d-flex flex-column w-100 gap-3">

            @foreach (var item in Model)
            {
                var price = item.GiaKhuyenMaiSP != null && item.GiaKhuyenMaiSP < item.DonGia ? item.GiaKhuyenMaiSP.Value : item.DonGia;

                <div class="card w-100 p-0 product-item" data-price="@price" data-original="@item.DonGia">
                    <div class="card-body row">
                        <div class="col-3 d-flex justify-content-center position-relative">
                            <input class="form-check-input rounded-circle position-absolute select-item"
                                   type="checkbox" style="top: -0.3rem; left: 0.5rem" name="@item.MaSP" value="1" />
                            <img src="@Url.Content("~/Content/Images/" + item.AnhDaiDienSP)" style="width: 7rem" />
                        </div>
                        <div class="col-9 d-flex flex-column gap-2">
                            <div class="d-flex justify-content-between">
                                <a class="text-wrap text-black fs-6 text-decoration-none"
                                   href="@Url.Action("ProductDetail", "Product", new { id = item.MaSP ?? item.MaGoiTap ?? item.MaLop })">
                                    @item.TenMonHang
                                </a>
                                <div>
                                    <button class="bg-transparent border-0 text-muted small" name="actionType" value="delete">Xóa</button>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                @if (item.GiaKhuyenMaiSP != null && item.GiaKhuyenMaiSP < item.DonGia)
                                {
                                    <div class="fs-6 text-danger mt-1">
                                        @item.GiaKhuyenMaiSP.Value.ToString("N0").Replace(",", ".") VNĐ
                                        <span class="text-secondary text-decoration-line-through ms-1 small">
                                            @item.DonGia.ToString("N0").Replace(",", ".") VNĐ
                                        </span>
                                    </div>
                                }
                                else
                                {
                                    <div class="fs-6 text-dark mt-1">
                                        @item.DonGia.ToString("N0").Replace(",", ".") VNĐ
                                    </div>
                                }

                                @if (item.MaSP != null)
                                {
                                    <input type="number" min="1" max="@item.SoLuongTon" value="@item.SoLuong" class="form-control p-0 ps-3 quantity" style="width: 4rem;" />
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
    <div class="mt-2 d-flex mx-auto px-5 fixed-bottom rounded-3" style="margin-top: 200px; width: 38rem">
        <div class="d-flex justify-content-between w-100 bg-light px-2 py-3">
            <div class="d-flex flex-column">
                <div class="fw-semibold fs-6">
                    Tạm tính:
                    <span id="total-price" class="fw-bold fs-6 text-danger">0 VNĐ</span>
                </div>
                <div class="small">Tiết kiệm <span id="saved" class="text-info"></span></div>
            </div>
            <button class="btn btn-info px-3 d-flex align-items-center text-white text-decoration-none fw-semibold" name="actionType" value="checkout">Mua ngay</button>
        </div>
    </div>
</form>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const selectAll = document.getElementById("select-all");
        const totalEl = document.getElementById("total-price");
        const savedEl = document.getElementById("saved");

        function updateTotal() {
            let total = 0;
            let saved = 0;

            document.querySelectorAll(".product-item").forEach(item => {
                const checkbox = item.querySelector(".select-item");
                const qtyInput = item.querySelector(".quantity");

                const qty = parseInt(qtyInput.value) || 1;
                const price = parseFloat(item.dataset.price);
                const original = parseFloat(item.dataset.original);

                if (checkbox.checked) {
                    total += qty * price;
                    if (original > price) {
                        saved += (original - price) * qty;
                    }
                }
            });

            totalEl.textContent = total.toLocaleString('vi-VN') + " VNĐ";
            savedEl.textContent = saved.toLocaleString('vi-VN') + " VNĐ";
        }

        selectAll.addEventListener("change", function () {
            const isChecked = this.checked;
            document.querySelectorAll(".select-item").forEach(cb => cb.checked = isChecked);
            updateTotal();
        });

        document.querySelectorAll(".select-item").forEach(cb => {
            cb.addEventListener("change", function () {
                const all = document.querySelectorAll(".select-item");
                const checked = document.querySelectorAll(".select-item:checked");
                selectAll.checked = all.length === checked.length;
                updateTotal();
            });
        });

        // Khi đổi số lượng
        document.querySelectorAll(".quantity").forEach(inp => inp.addEventListener("input", updateTotal));
    });
</script>
